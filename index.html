<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生能力儀表板</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        canvas {
            max-width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 text-gray-800">

    <!-- 登入頁面 -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold text-center text-indigo-700 mb-6">登入儀表板</h2>
            <div class="mb-4">
                <label for="username-input" class="block text-lg font-medium text-gray-700 mb-2">帳號:</label>
                <input type="text" id="username-input" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" placeholder="輸入帳號">
            </div>
            <div class="mb-6">
                <label for="password-input" class="block text-lg font-medium text-gray-700 mb-2">密碼:</label>
                <input type="password" id="password-input" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" placeholder="輸入密碼">
            </div>
            <!-- 身份選擇下拉選單已移除 -->
            <button id="login-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 font-semibold">
                登入
            </button>
            <p id="login-error-message" class="text-red-500 text-center mt-4 hidden">帳號或密碼錯誤，請重試。</p>
        </div>
    </div>

    <!-- 儀表板內容 -->
    <div id="dashboard-content" class="hidden">
        <!-- 儀表板標題 -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6 flex justify-between items-center flex-wrap">
            <h1 class="text-3xl font-bold text-indigo-700">學生能力儀表板</h1>
            <div id="user-info-display" class="flex items-center space-x-4">
                <div id="logged-in-user-display" class="text-sm text-gray-600">
                    目前登入: <span class="font-semibold" id="logged-in-username"></span> (<span id="logged-in-role"></span>)
                </div>
                <button id="logout-btn" class="px-4 py-2 rounded-md bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 font-semibold">
                    登出
                </button>
            </div>
        </header>

        <!-- 控制按鈕 (僅老師可見) -->
        <div id="teacher-controls" class="flex justify-center mb-6 space-x-4 hidden">
            <button id="show-overall-btn"
                class="px-6 py-3 rounded-full text-lg font-semibold shadow-lg transition-all duration-300
                       bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                顯示整體數據
            </button>
            <button id="show-personal-btn"
                class="px-6 py-3 rounded-full text-lg font-semibold shadow-lg transition-all duration-300
                       bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                顯示個人數據
            </button>
        </div>

        <!-- 個人化視圖 -->
        <section id="personal-view-section" class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">個人化學生表現</h2>
            <div id="personal-filters" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- 職級選擇 -->
                <div>
                    <label for="rank-select" class="block text-lg font-medium text-gray-700 mb-2">
                        選擇職級:
                    </label>
                    <select id="rank-select"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <!-- 科別選擇 -->
                <div>
                    <label for="course-filter-select" class="block text-lg font-medium text-gray-700 mb-2">
                        選擇科別:
                    </label>
                    <select id="course-filter-select"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <!-- 學員選擇 -->
                <div>
                    <label for="student-select" class="block text-lg font-medium text-gray-700 mb-2">
                        選擇學員:
                    </label>
                    <select id="student-select"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div id="personal-data-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                <!-- 等級 (Leval) 卡片 -->
                <div class="bg-indigo-50 p-6 rounded-lg shadow-inner flex items-center justify-between">
                    <div>
                        <p class="text-lg text-indigo-800">等級 (Leval):</p>
                        <p id="student-leval" class="text-4xl font-bold text-indigo-700"></p>
                    </div>
                    <svg class="w-16 h-16 text-indigo-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                </div>

                <!-- 完成率卡片 -->
                <div class="bg-green-50 p-6 rounded-lg shadow-inner flex items-center justify-between">
                    <div>
                        <p class="text-lg text-green-800">課程完成率:</p>
                        <p id="student-completion-rate" class="text-4xl font-bold text-green-700"></p>
                    </div>
                    <svg class="w-16 h-16 text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>

                <!-- 訓練成績卡片 -->
                <div class="bg-yellow-50 p-6 rounded-lg shadow-inner flex items-center justify-between">
                    <div>
                        <p class="text-lg text-yellow-800">訓練成績:</p>
                        <p id="student-training-score" class="text-4xl font-bold text-yellow-700"></p>
                    </div>
                    <svg class="w-16 h-16 text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17.555 1.683a1 1 0 00-1.333-.333l-1.92 1.92a1 1 0 00-.28 1.04l.39 1.56a1 1 0 00.95 1.05l1.56.39a1 1 0 001.04-.28l1.92-1.92a1 1 0 00-.333-1.333zM16 14a6 6 0 01-6 6H4a6 6 0 01-6-6V8a6 6 0 016-6h6a6 6 0 016 6v6z"></path>
                    </svg>
                </div>
            </div>
            <p id="personal-data-message" class="text-center text-gray-500 mt-4 hidden"></p>

            <!-- 個人分析圖表 (新增加，拆分為三個) -->
            <div id="personal-analysis-charts-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 hidden">
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                    <h4 id="personal-leval-comparison-title" class="text-lg font-semibold text-gray-800 mb-2 text-center">個人等級與整體平均</h4>
                    <canvas id="personalLevalComparisonChart"></canvas>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                    <h4 id="personal-completion-comparison-title" class="text-lg font-semibold text-gray-800 mb-2 text-center">個人完成率與整體平均</h4>
                    <canvas id="personalCompletionComparisonChart"></canvas>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                    <h4 id="personal-training-score-comparison-title" class="text-lg font-semibold text-gray-800 mb-2 text-center">個人訓練成績與整體平均</h4>
                    <canvas id="personalTrainingScoreComparisonChart"></canvas>
                </div>
            </div>
        </section>

        <!-- 整體表現視圖 (僅老師可見) -->
        <section id="overall-view-section" class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">整體表現概覽</h2>

            <!-- 按職級分類的圖表 -->
            <div class="mb-8">
                <h3 class="text-xl font-medium text-gray-700 mb-4">按職級分類</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                        <h4 id="overall-rank-leval-title" class="text-lg font-semibold text-gray-800 mb-2 text-center"></h4>
                        <canvas id="rankLevalChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                        <h4 id="overall-rank-completion-title" class="text-lg font-semibold text-gray-800 mb-2 text-center"></h4>
                        <canvas id="rankCompletionChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                        <h4 id="overall-rank-training-score-title" class="text-lg font-semibold text-gray-800 mb-2 text-center"></h4>
                        <canvas id="rankTrainingScoreChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 按課程分類的圖表 -->
            <div>
                <h3 class="text-xl font-medium text-gray-700 mb-4">按課程分類</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                        <h4 id="overall-course-leval-title" class="text-lg font-semibold text-gray-800 mb-2 text-center"></h4>
                        <canvas id="courseLevalChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                        <h4 id="overall-course-completion-title" class="text-lg font-semibold text-gray-800 mb-2 text-center"></h4>
                        <canvas id="courseCompletionChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm h-80">
                        <h4 id="overall-course-training-score-title" class="text-lg font-semibold text-gray-800 mb-2 text-center"></h4>
                        <canvas id="courseTrainingScoreChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI 建議區塊 -->
        <section class="bg-white shadow-md rounded-lg p-6 mt-6">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">AI 建議</h2>
            <div class="mb-4">
                <button id="get-ai-suggestion-btn" class="px-6 py-3 rounded-full text-lg font-semibold shadow-lg transition-all duration-300
                               bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    獲取 AI 建議
                </button>
            </div>
            <div id="ai-suggestion-output" class="bg-blue-50 p-4 rounded-lg text-blue-800 italic">
                點擊上方按鈕獲取 AI 建議。
            </div>
            <div id="ai-loading-indicator" class="hidden text-center text-blue-500 mt-2">
                生成中...
            </div>
        </section>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Data from the CSV file ---
        const studentData = [
            { "職級": "PGY1", "學員": "A學員", "Leval": 3, "課程": "內科", "應完成": 5, "完成": 2, "訓練成績": 89 },
            { "職級": "PGY1", "學員": "B學員", "Leval": 2, "課程": "內科", "應完成": 5, "完成": 4, "訓練成績": 82 },
            { "職級": "PGY1", "學員": "C學員", "Leval": 2, "課程": "外科", "應完成": 5, "完成": 3, "訓練成績": 90 },
            { "職級": "PGY1", "學員": "D學員", "Leval": 2, "課程": "外科", "應完成": 5, "完成": 4, "訓練成績": 85 },
            { "職級": "PGY1", "學員": "E學員", "Leval": 4, "課程": "婦產", "應完成": 5, "完成": 2, "訓練成績": 86 },
            { "職級": "PGY1", "學員": "F學員", "Leval": 3, "課程": "兒科", "應完成": 5, "完成": 3, "訓練成績": 80 },
            { "職級": "PGY2", "學員": "G學員", "Leval": 3, "課程": "外科", "應完成": 5, "完成": 2, "訓練成績": 88 },
            { "職級": "PGY2", "學員": "H學員", "Leval": 2, "課程": "外科", "應完成": 5, "完成": 4, "訓練成績": 89 },
            { "職級": "PGY2", "學員": "I學員", "Leval": 2, "課程": "兒科", "應完成": 5, "完成": 3, "訓練成績": 92 },
            { "職級": "PGY2", "學員": "J學員", "Leval": 2, "課程": "兒科", "應完成": 5, "完成": 4, "訓練成績": 91 },
            { "職級": "PGY2", "學員": "K學員", "Leval": 4, "課程": "婦產", "應完成": 5, "完成": 2, "訓練成績": 95 },
            { "職級": "PGY2", "學員": "L學員", "Leval": 3, "課程": "內科", "應完成": 5, "完成": 3, "訓練成績": 88 }
        ];

        // Calculate completion rate for each student
        const processedStudentData = studentData.map(student => ({
            ...student,
            完成率: student['完成'] / student['應完成']
        }));

        // Get unique ranks and courses for the filter dropdowns
        const uniqueRanks = ['所有職級', ...new Set(processedStudentData.map(s => s['職級']))];
        const uniqueCourses = ['所有科別', ...new Set(processedStudentData.map(s => s['課程']))];

        // Pre-calculate aggregated data for overall views (from ALL students)
        const overallByRankAggregated = (() => {
            const aggregate = processedStudentData.reduce((acc, student) => {
                if (!acc[student['職級']]) {
                    acc[student['職級']] = { LevalSum: 0, CompletionRateSum: 0, TrainingScoreSum: 0, count: 0 };
                }
                acc[student['職級']].LevalSum += student['Leval'];
                acc[student['職級']].CompletionRateSum += student['完成率'];
                acc[student['職級']].TrainingScoreSum += student['訓練成績'];
                acc[student['職級']].count++;
                return acc;
            }, {});
            return Object.keys(aggregate).map(rank => ({
                職級: rank,
                Leval: aggregate[rank].LevalSum / aggregate[rank].count,
                完成率: aggregate[rank].CompletionRateSum / aggregate[rank].count,
                訓練成績: aggregate[rank].TrainingScoreSum / aggregate[rank].count
            }));
        })();

        const overallByCourseAggregated = (() => {
            const aggregate = processedStudentData.reduce((acc, student) => {
                if (!acc[student['課程']]) {
                    acc[student['課程']] = { LevalSum: 0, CompletionRateSum: 0, TrainingScoreSum: 0, count: 0 };
                }
                acc[student['課程']].LevalSum += student['Leval'];
                acc[student['課程']].CompletionRateSum += student['完成率'];
                acc[student['課程']].TrainingScoreSum += student['訓練成績'];
                acc[student['課程']].count++;
                return acc;
            }, {});
            return Object.keys(aggregate).map(course => ({
                課程: course,
                Leval: aggregate[course].LevalSum / aggregate[course].count,
                完成率: aggregate[course].CompletionRateSum / aggregate[course].count,
                訓練成績: aggregate[course].TrainingScoreSum / aggregate[course].count
            }));
        })();

        // Pre-calculate overall average metrics across all students
        const overallAverageMetrics = (() => {
            const totalLeval = processedStudentData.reduce((sum, student) => sum + student['Leval'], 0);
            const totalCompletionRate = processedStudentData.reduce((sum, student) => sum + student['完成率'], 0);
            const totalTrainingScore = processedStudentData.reduce((sum, student) => sum + student['訓練成績'], 0);
            const count = processedStudentData.length;

            return {
                Leval: count > 0 ? totalLeval / count : 0,
                完成率: count > 0 ? totalCompletionRate / count : 0,
                訓練成績: count > 0 ? totalTrainingScore / count : 0,
            };
        })();

        // --- Global State Variables ---
        let selectedRank = '所有職級';
        let selectedCourse = '所有科別';
        let selectedStudent = '';
        let isOverallView = false;
        let currentLoggedInUsername = ''; // New: Stores the username of the logged-in user
        let currentLoggedInRole = ''; // New: Stores the role of the logged-in user
        let isAuthReady = false;
        let userRole = 'guest'; // 'guest', 'teacher', 'student'

        // --- Demo User Credentials ---
        const demoUsers = {
            teacher: { username: 'teacher', password: 'password', role: 'teacher' },
        };
        // Dynamically add student users
        processedStudentData.forEach(student => {
            demoUsers[student['學員']] = {
                username: student['學員'], // Student's name as username
                password: 'password', // Generic password for all students
                role: 'student',
                associatedStudent: student['學員']
            };
        });


        // --- Chart Instances ---
        let rankLevalChartInstance = null;
        let rankCompletionChartInstance = null;
        let rankTrainingScoreChartInstance = null;
        let courseLevalChartInstance = null;
        let courseCompletionChartInstance = null;
        let courseTrainingScoreChartInstance = null;
        let personalLevalComparisonChartInstance = null; // New chart instance
        let personalCompletionComparisonChartInstance = null; // New chart instance
        let personalTrainingScoreComparisonChartInstance = null; // New chart instance


        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const dashboardContent = document.getElementById('dashboard-content');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginErrorMessage = document.getElementById('login-error-message');
        const logoutBtn = document.getElementById('logout-btn');

        const personalViewSection = document.getElementById('personal-view-section');
        const personalFilters = document.getElementById('personal-filters');
        const rankSelect = document.getElementById('rank-select');
        const courseFilterSelect = document.getElementById('course-filter-select');
        const studentSelect = document.getElementById('student-select');
        const studentLevalDisplay = document.getElementById('student-leval');
        const studentCompletionRateDisplay = document.getElementById('student-completion-rate');
        const studentTrainingScoreDisplay = document.getElementById('student-training-score');
        const personalDataCards = document.getElementById('personal-data-cards');
        const personalDataMessage = document.getElementById('personal-data-message');
        const personalAnalysisChartsContainer = document.getElementById('personal-analysis-charts-container'); // New container
        const personalLevalComparisonChartCanvas = document.getElementById('personalLevalComparisonChart'); // New canvas
        const personalCompletionComparisonChartCanvas = document.getElementById('personalCompletionComparisonChart'); // New canvas
        const personalTrainingScoreComparisonChartCanvas = document.getElementById('personalTrainingScoreComparisonChart'); // New canvas
        const personalLevalComparisonTitle = document.getElementById('personal-leval-comparison-title');
        const personalCompletionComparisonTitle = document.getElementById('personal-completion-comparison-title');
        const personalTrainingScoreComparisonTitle = document.getElementById('personal-training-score-comparison-title');


        const teacherControls = document.getElementById('teacher-controls');
        const showOverallBtn = document.getElementById('show-overall-btn');
        const showPersonalBtn = document.getElementById('show-personal-btn');
        const overallViewSection = document.getElementById('overall-view-section');

        const overallRankLevalTitle = document.getElementById('overall-rank-leval-title');
        const overallRankCompletionTitle = document.getElementById('overall-rank-completion-title');
        const overallRankTrainingScoreTitle = document.getElementById('overall-rank-training-score-title');
        const overallCourseLevalTitle = document.getElementById('overall-course-leval-title');
        const overallCourseCompletionTitle = document.getElementById('overall-course-completion-title');
        const overallCourseTrainingScoreTitle = document.getElementById('overall-course-training-score-title');

        const loggedInUserDisplay = document.getElementById('logged-in-user-display'); // New
        const loggedInUsernameSpan = document.getElementById('logged-in-username'); // New
        const loggedInRoleSpan = document.getElementById('logged-in-role'); // New

        const getAiSuggestionBtn = document.getElementById('get-ai-suggestion-btn');
        const aiSuggestionOutput = document.getElementById('ai-suggestion-output');
        const aiLoadingIndicator = document.getElementById('ai-loading-indicator');

        // --- Firebase Initialization ---
        window.onload = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app); // eslint-disable-line no-unused-vars
                    const firebaseAuth = getAuth(app);

                    onAuthStateChanged(firebaseAuth, async (user) => {
                        if (user) {
                            // Firebase user ID is not directly used for display in this context
                            // currentUserId = user.uid; // Keep this if needed for Firestore rules
                            // userIdDisplayDiv.classList.remove('hidden'); // This div is now removed or repurposed
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await signInWithCustomToken(firebaseAuth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(firebaseAuth);
                                }
                            } catch (error) {
                                console.error("Firebase anonymous sign-in failed:", error);
                            }
                        }
                        isAuthReady = true;
                        renderDashboard(); // Initial render after auth state is known
                    });
                } else {
                    console.warn("Firebase config not found. Running without Firebase.");
                    isAuthReady = true;
                    renderDashboard(); // Initial render even without Firebase
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                isAuthReady = true;
                renderDashboard(); // Initial render even if Firebase init fails
            }
        };


        // --- Helper Functions ---

        // Filters students based on the selected rank and course
        function getFilteredStudents() {
            let filtered = processedStudentData;

            if (selectedRank !== '所有職級') {
                filtered = filtered.filter(s => s['職級'] === selectedRank);
            }
            if (selectedCourse !== '所有科別') {
                filtered = filtered.filter(s => s['課程'] === selectedCourse);
            }
            return filtered;
        }

        // Gets the data for the currently selected student
        function getCurrentStudentData() {
            const filtered = getFilteredStudents();
            return filtered.find(s => s['學員'] === selectedStudent);
        }

        // Renders a Chart.js bar chart
        function renderChart(canvasId, data, labelKey, valueKey, chartTitle, barColor, legendLabel, tickFormatter = null) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing chart instance for this canvas if it exists
            let chartInstance;
            switch(canvasId) {
                case 'rankLevalChart':
                    chartInstance = rankLevalChartInstance;
                    break;
                case 'rankCompletionChart':
                    chartInstance = rankCompletionChartInstance;
                    break;
                case 'rankTrainingScoreChart':
                    chartInstance = rankTrainingScoreChartInstance;
                    break;
                case 'courseLevalChart':
                    chartInstance = courseLevalChartInstance;
                    break;
                case 'courseCompletionChart':
                    chartInstance = courseCompletionChartInstance;
                    break;
                case 'courseTrainingScoreChart':
                    chartInstance = courseTrainingScoreChartInstance;
                    break;
                case 'personalLevalComparisonChart':
                    chartInstance = personalLevalComparisonChartInstance;
                    break;
                case 'personalCompletionComparisonChart':
                    chartInstance = personalCompletionComparisonChartInstance;
                    break;
                case 'personalTrainingScoreComparisonChart':
                    chartInstance = personalTrainingScoreComparisonChartInstance;
                    break;
            }

            if (chartInstance) {
                chartInstance.destroy();
            }

            const datasets = [{
                label: legendLabel,
                data: data.map(item => item[valueKey]),
                backgroundColor: barColor,
                borderColor: barColor,
                borderWidth: 1,
                borderRadius: 5,
            }];

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (tickFormatter) {
                                    label += tickFormatter(context.raw);
                                } else {
                                    label += context.raw;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: labelKey === '職級' ? '職級' : (labelKey === '課程' ? '課程' : '指標') // Adjusted for personal chart
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: valueKey === 'Leval' ? '等級' : (valueKey === '完成率' ? '完成率' : '訓練成績')
                        },
                        ticks: {
                            callback: tickFormatter || Chart.Ticks.formatters.numeric
                        }
                    }
                }
            };

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: data.map(item => item[labelKey]),
                    datasets: datasets
                },
                options: options
            };

            const newChartInstance = new Chart(ctx, chartConfig);

            // Store the new chart instance
            switch(canvasId) {
                case 'rankLevalChart':
                    rankLevalChartInstance = newChartInstance;
                    break;
                case 'rankCompletionChart':
                    rankCompletionChartInstance = newChartInstance;
                    break;
                case 'rankTrainingScoreChart':
                    rankTrainingScoreChartInstance = newChartInstance;
                    break;
                case 'courseLevalChart':
                    courseLevalChartInstance = newChartInstance;
                    break;
                case 'courseCompletionChart':
                    courseCompletionChartInstance = newChartInstance;
                    break;
                case 'courseTrainingScoreChart':
                    courseTrainingScoreChartInstance = newChartInstance;
                    break;
                case 'personalLevalComparisonChart':
                    personalLevalComparisonChartInstance = newChartInstance;
                    break;
                case 'personalCompletionComparisonChart':
                    personalCompletionComparisonChartInstance = newChartInstance;
                    break;
                case 'personalTrainingScoreComparisonChart':
                    personalTrainingScoreComparisonChartInstance = newChartInstance;
                    break;
            }
        }

        // --- AI Suggestion Logic ---
        async function getAISuggestion() {
            aiLoadingIndicator.classList.remove('hidden');
            aiSuggestionOutput.textContent = ''; // Clear previous suggestion

            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            let suggestion = "目前沒有可用的 AI 建議。";
            const currentStudentData = getCurrentStudentData();

            if (userRole === 'teacher') {
                if (isOverallView) {
                    suggestion = "作為老師，整體數據顯示 PGY1 和 PGY2 的平均等級和完成率趨於穩定。您可以考慮針對完成率較低的課程（如婦產科）設計額外輔導計畫，或分析不同職級在特定課程上的表現差異，以優化教學策略。";
                } else if (currentStudentData) {
                    suggestion = `作為老師，針對學員 ${currentStudentData['學員']}：\n\n`;
                    suggestion += `- 等級 (Leval): ${currentStudentData['Leval']}。考慮提供更高難度的挑戰或更深入的學習資源，以幫助其提升至更高水平。\n`;
                    suggestion += `- 課程完成率: ${(currentStudentData['完成率'] * 100).toFixed(0)}%。若完成率較低，建議與其溝通了解困難點，並提供額外輔導或調整學習進度。\n`;
                    suggestion += `- 訓練成績: ${currentStudentData['訓練成績']}。若成績低於預期，可針對其薄弱環節提供加強訓練或額外練習。`;
                } else {
                    suggestion = "請選擇一位學員以獲取針對個人的 AI 建議。";
                }
            } else if (userRole === 'student' && currentStudentData) {
                suggestion = `作為學員 ${currentStudentData['學員']}：\n\n`;
                suggestion += `- 您的等級 (Leval) 為 ${currentStudentData['Leval']}。您可以尋求導師的指導，或參與相關研討會來進一步提升您的專業能力。\n`;
                suggestion += `- 您的課程完成率為 ${(currentStudentData['完成率'] * 100).toFixed(0)}%。若有未完成的課程，請優先完成，並檢視學習方法是否有效。\n`;
                suggestion += `- 您的訓練成績為 ${currentStudentData['訓練成績']}。這是一個不錯的成績！您可以繼續保持，並針對您感興趣的領域進行更深入的學習，或尋找實習機會來應用所學。`;
            } else if (userRole === 'student' && !currentStudentData) {
                 suggestion = "您好，學生儀表板目前只顯示您個人的數據。若數據未載入，請聯繫管理員。";
            }

            aiSuggestionOutput.textContent = suggestion;
            aiLoadingIndicator.classList.add('hidden');

            // --- Real LLM API Call Placeholder (if a backend is available) ---
            /*
            let prompt = "";
            if (userRole === 'teacher') {
                if (isOverallView) {
                    prompt = "請根據以下學員的整體表現數據，為老師提供教學策略建議：\n" + JSON.stringify(overallByRankAggregated) + "\n" + JSON.stringify(overallByCourseAggregated);
                } else if (currentStudentData) {
                    prompt = `請根據以下學員 ${currentStudentData['學員']} 的個人表現數據，為老師提供個性化輔導建議：\n` + JSON.stringify(currentStudentData);
                }
            } else if (userRole === 'student' && currentStudentData) {
                prompt = `請根據我作為學員 ${currentStudentData['學員']} 的個人表現數據，為我提供學習和提升的建議：\n` + JSON.stringify(currentStudentData);
            }

            if (prompt) {
                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        aiSuggestionOutput.textContent = text;
                    } else {
                        aiSuggestionOutput.textContent = "未能獲取 AI 建議，請稍後再試。";
                    }
                } catch (error) {
                    console.error("Error fetching AI suggestion:", error);
                    aiSuggestionOutput.textContent = "獲取 AI 建議時發生錯誤。";
                }
            } else {
                aiSuggestionOutput.textContent = "目前沒有可用的 AI 建議。";
            }
            aiLoadingIndicator.classList.add('hidden');
            */
        }

        // --- Main Render Function ---
        function renderDashboard() {
            // Show/hide login page and dashboard content
            if (userRole === 'guest') {
                loginPage.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
                return; // Stop rendering dashboard if not logged in
            } else {
                loginPage.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            }

            // Update logged-in user display
            loggedInUsernameSpan.textContent = currentLoggedInUsername;
            loggedInRoleSpan.textContent = userRole === 'teacher' ? '老師' : '學生';


            // Teacher vs Student view logic
            if (userRole === 'teacher') {
                teacherControls.classList.remove('hidden');
                personalFilters.classList.remove('hidden'); // Show all filters for teacher
                overallViewSection.classList.remove('hidden'); // Show overall view for teacher

                // Update button styles for teacher
                showOverallBtn.classList.toggle('bg-indigo-700', isOverallView);
                showOverallBtn.classList.toggle('bg-indigo-600', !isOverallView);
                showPersonalBtn.classList.toggle('bg-indigo-700', !isOverallView);
                showPersonalBtn.classList.toggle('bg-indigo-600', isOverallView);

            } else if (userRole === 'student') {
                teacherControls.classList.add('hidden');
                personalFilters.classList.add('hidden'); // Hide filters for student
                overallViewSection.classList.add('hidden'); // Hide overall view for student
                isOverallView = false; // Force personal view for student
                
                // For student, ensure selected student matches their associated student
                const loggedInStudentData = processedStudentData.find(s => s['學員'] === selectedStudent);
                if (loggedInStudentData) {
                    selectedRank = loggedInStudentData['職級'];
                    selectedCourse = loggedInStudentData['課程'];
                    // selectedStudent is already set during login for student
                } else {
                    // Fallback if associated student data is somehow missing
                    selectedRank = '所有職級';
                    selectedCourse = '所有科別';
                    selectedStudent = '';
                    console.error(`Error: Student's associated data for '${selectedStudent}' not found.`);
                }
            }

            // Populate Rank Select (only visible for teacher, but logic runs)
            rankSelect.innerHTML = '';
            uniqueRanks.forEach(rank => {
                const option = document.createElement('option');
                option.value = rank;
                option.textContent = rank;
                rankSelect.appendChild(option);
            });
            rankSelect.value = selectedRank;

            // Populate Course Filter Select (only visible for teacher, but logic runs)
            courseFilterSelect.innerHTML = '';
            uniqueCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                courseFilterSelect.appendChild(option);
            });
            courseFilterSelect.value = selectedCourse;


            // Filter students based on selected rank and course
            const filteredStudents = getFilteredStudents();

            // Update selected student if current one is not in filtered list (only for teacher)
            if (userRole === 'teacher') {
                if (filteredStudents.length > 0) {
                    if (!filteredStudents.some(s => s['學員'] === selectedStudent)) {
                        selectedStudent = filteredStudents[0]['學員'];
                    }
                } else {
                    selectedStudent = ''; // No students in this rank/course combination
                }
            }


            // Populate Student Select (only visible for teacher, but logic runs)
            studentSelect.innerHTML = '';
            if (filteredStudents.length > 0) {
                studentSelect.disabled = false;
                filteredStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student['學員'];
                    option.textContent = student['學員'];
                    studentSelect.appendChild(option);
                });
                studentSelect.value = selectedStudent;
            } else {
                studentSelect.disabled = true;
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '無學員';
                studentSelect.appendChild(option);
                selectedStudent = ''; // Ensure selectedStudent is empty if no options
            }

            const currentStudentData = getCurrentStudentData();

            // Update personal data cards
            if (!isOverallView && currentStudentData) {
                personalDataCards.classList.remove('hidden');
                personalDataMessage.classList.add('hidden');
                studentLevalDisplay.textContent = currentStudentData['Leval'];
                studentCompletionRateDisplay.textContent = `${(currentStudentData['完成率'] * 100).toFixed(0)}%`;
                studentTrainingScoreDisplay.textContent = currentStudentData['訓練成績'];
                
                // Render personal comparison charts
                const levalComparisonData = [
                    { label: '您的表現', value: currentStudentData['Leval'] },
                    { label: '整體平均', value: overallAverageMetrics.Leval }
                ];
                const completionComparisonData = [
                    { label: '您的表現', value: currentStudentData['完成率'] * 100 },
                    { label: '整體平均', value: overallAverageMetrics.完成率 * 100 }
                ];
                const trainingScoreComparisonData = [
                    { label: '您的表現', value: currentStudentData['訓練成績'] },
                    { label: '整體平均', value: overallAverageMetrics.訓練成績 }
                ];

                personalAnalysisChartsContainer.classList.remove('hidden'); // Show the container
                renderChart('personalLevalComparisonChart', levalComparisonData, 'label', 'value', personalLevalComparisonTitle.textContent, ['#8884d8', '#cccccc'], '等級');
                renderChart('personalCompletionComparisonChart', completionComparisonData, 'label', 'value', personalCompletionComparisonTitle.textContent, ['#82ca9d', '#cccccc'], '完成率', (value) => `${value.toFixed(0)}%`);
                renderChart('personalTrainingScoreComparisonChart', trainingScoreComparisonData, 'label', 'value', personalTrainingScoreComparisonTitle.textContent, ['#FFCE56', '#cccccc'], '訓練成績');

            } else {
                personalDataCards.classList.add('hidden');
                personalDataMessage.classList.add('hidden'); // Ensure message is hidden by default
                personalAnalysisChartsContainer.classList.add('hidden'); // Hide personal analysis charts
                // Clear and destroy personal comparison chart instances when not in use
                if (personalLevalComparisonChartInstance) { personalLevalComparisonChartInstance.destroy(); personalLevalComparisonChartInstance = null; }
                if (personalCompletionComparisonChartInstance) { personalCompletionComparisonChartInstance.destroy(); personalCompletionComparisonChartInstance = null; }
                if (personalTrainingScoreComparisonChartInstance) { personalTrainingScoreComparisonChartInstance.destroy(); personalTrainingScoreComparisonChartInstance = null; }

                if (!isOverallView && filteredStudents.length > 0 && !currentStudentData && userRole === 'teacher') {
                    personalDataMessage.classList.remove('hidden');
                    personalDataMessage.textContent = '請從下拉選單中選擇一位學員以查看詳細數據。';
                } else if (!isOverallView && filteredStudents.length === 0 && (selectedRank !== '所有職級' || selectedCourse !== '所有科別') && userRole === 'teacher') {
                    personalDataMessage.classList.remove('hidden');
                    let message = '在';
                    if (selectedRank !== '所有職級') message += `「${selectedRank}」職級`;
                    if (selectedRank !== '所有職級' && selectedCourse !== '所有科別') message += '和';
                    if (selectedCourse !== '所有科別') message += `「${selectedCourse}」科別`;
                    message += '中沒有學員數據。';
                    personalDataMessage.textContent = message;
                }
            }


            // Determine data for overall charts
            let displayOverallByRankData;
            let displayOverallByCourseData;
            let legendNameLeval;
            let legendNameCompletionRate;
            let legendNameTrainingScore;

            if (isOverallView) {
                displayOverallByRankData = overallByRankAggregated;
                displayOverallByCourseData = overallByCourseAggregated;
                legendNameLeval = "平均等級";
                legendNameCompletionRate = "平均完成率";
                legendNameTrainingScore = "平均訓練成績";
            } else if (currentStudentData) {
                displayOverallByRankData = [{
                    職級: currentStudentData['職級'],
                    Leval: currentStudentData['Leval'],
                    完成率: currentStudentData['完成率'],
                    訓練成績: currentStudentData['訓練成績']
                }];
                displayOverallByCourseData = [{
                    課程: currentStudentData['課程'],
                    Leval: currentStudentData['Leval'],
                    完成率: currentStudentData['完成率'],
                    訓練成績: currentStudentData['訓練成績']
                }];
                legendNameLeval = "等級";
                legendNameCompletionRate = "完成率";
                legendNameTrainingScore = "訓練成績";
            } else {
                displayOverallByRankData = [];
                displayOverallByCourseData = [];
                legendNameLeval = "等級";
                legendNameCompletionRate = "完成率";
                legendNameTrainingScore = "訓練成績";
            }

            // Update chart titles
            overallRankLevalTitle.textContent = isOverallView
                ? '各職級平均等級 (Leval)'
                : (currentStudentData ? `學員 ${selectedStudent} 在 ${currentStudentData['職級']} 的等級` : '請選擇學員');
            overallRankCompletionTitle.textContent = isOverallView
                ? '各職級平均課程完成率'
                : (currentStudentData ? `學員 ${selectedStudent} 在 ${currentStudentData['職級']} 的課程完成率` : '請選擇學員');
            overallRankTrainingScoreTitle.textContent = isOverallView
                ? '各職級平均訓練成績'
                : (currentStudentData ? `學員 ${selectedStudent} 在 ${currentStudentData['職級']} 的訓練成績` : '請選擇學員');

            overallCourseLevalTitle.textContent = isOverallView
                ? '各課程平均等級 (Leval)'
                : (currentStudentData ? `學員 ${selectedStudent} 在 ${currentStudentData['課程']} 的等級` : '請選擇學員');
            overallCourseCompletionTitle.textContent = isOverallView
                ? '各課程平均課程完成率'
                : (currentStudentData ? `學員 ${selectedStudent} 在 ${currentStudentData['課程']} 的課程完成率` : '請選擇學員');
            overallCourseTrainingScoreTitle.textContent = isOverallView
                ? '各課程平均訓練成績'
                : (currentStudentData ? `學員 ${selectedStudent} 在 ${currentStudentData['課程']} 的訓練成績` : '請選擇學員');

            // Render charts
            // Only render charts if data exists, otherwise clear canvas and destroy instances
            if (displayOverallByRankData.length > 0) {
                renderChart('rankLevalChart', displayOverallByRankData, '職級', 'Leval', overallRankLevalTitle.textContent, '#8884d8', legendNameLeval);
                renderChart('rankCompletionChart', displayOverallByRankData, '職級', '完成率', overallRankCompletionTitle.textContent, '#82ca9d', legendNameCompletionRate, (value) => `${(value * 100).toFixed(2)}%`);
                renderChart('rankTrainingScoreChart', displayOverallByRankData, '職級', '訓練成績', overallRankTrainingScoreTitle.textContent, '#FFCE56', legendNameTrainingScore);
            } else {
                document.getElementById('rankLevalChart').getContext('2d').clearRect(0, 0, document.getElementById('rankLevalChart').width, document.getElementById('rankLevalChart').height);
                document.getElementById('rankCompletionChart').getContext('2d').clearRect(0, 0, document.getElementById('rankCompletionChart').width, document.getElementById('rankCompletionChart').height);
                document.getElementById('rankTrainingScoreChart').getContext('2d').clearRect(0, 0, document.getElementById('rankTrainingScoreChart').width, document.getElementById('rankTrainingScoreChart').height);
                if (rankLevalChartInstance) { rankLevalChartInstance.destroy(); rankLevalChartInstance = null; }
                if (rankCompletionChartInstance) { rankCompletionChartInstance.destroy(); rankCompletionChartInstance = null; }
                if (rankTrainingScoreChartInstance) { rankTrainingScoreChartInstance.destroy(); rankTrainingScoreChartInstance = null; }
            }

            if (displayOverallByCourseData.length > 0) {
                renderChart('courseLevalChart', displayOverallByCourseData, '課程', 'Leval', overallCourseLevalTitle.textContent, '#ffc658', legendNameLeval);
                renderChart('courseCompletionChart', displayOverallByCourseData, '課程', '完成率', overallCourseCompletionTitle.textContent, '#a4de6c', legendNameCompletionRate, (value) => `${(value * 100).toFixed(2)}%`);
                renderChart('courseTrainingScoreChart', displayOverallByCourseData, '課程', '訓練成績', overallCourseTrainingScoreTitle.textContent, '#FF6384', legendNameTrainingScore);
            } else {
                document.getElementById('courseLevalChart').getContext('2d').clearRect(0, 0, document.getElementById('courseLevalChart').width, document.getElementById('courseLevalChart').height);
                document.getElementById('courseCompletionChart').getContext('2d').clearRect(0, 0, document.getElementById('courseCompletionChart').width, document.getElementById('courseCompletionChart').height);
                document.getElementById('courseTrainingScoreChart').getContext('2d').clearRect(0, 0, document.getElementById('courseTrainingScoreChart').width, document.getElementById('courseTrainingScoreChart').height);
                if (courseLevalChartInstance) { courseLevalChartInstance.destroy(); courseLevalChartInstance = null; }
                if (courseCompletionChartInstance) { courseCompletionChartInstance.destroy(); courseCompletionChartInstance = null; }
                if (courseTrainingScoreChartInstance) { courseTrainingScoreChartInstance.destroy(); courseTrainingScoreChartInstance = null; }
            }
        }

        // --- Event Listeners ---
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            const user = demoUsers[username]; // 直接根據帳號查找用戶

            if (user && user.password === password) { // 只需要驗證帳號和密碼
                userRole = user.role; // 從找到的用戶對象中獲取角色
                currentLoggedInUsername = user.username; // Store the logged-in username
                currentLoggedInRole = user.role; // Store the logged-in role
                loginErrorMessage.classList.add('hidden'); // 隱藏錯誤訊息

                if (userRole === 'student') {
                    selectedStudent = user.associatedStudent; // 設定為該學員的數據
                    isOverallView = false; // 學生強制為個人視圖
                } else { // 老師
                    isOverallView = true; // 老師預設為整體視圖
                    selectedRank = '所有職級';
                    selectedCourse = '所有科別';
                    selectedStudent = processedStudentData.length > 0 ? processedStudentData[0]['學員'] : '';
                }
                renderDashboard();
            } else {
                loginErrorMessage.classList.remove('hidden'); // 顯示錯誤訊息
            }
        });

        logoutBtn.addEventListener('click', () => {
            userRole = 'guest';
            currentLoggedInUsername = ''; // Clear logged-in username
            currentLoggedInRole = ''; // Clear logged-in role
            selectedRank = '所有職級';
            selectedCourse = '所有科別';
            selectedStudent = '';
            isOverallView = false;
            renderDashboard();
        });

        rankSelect.addEventListener('change', (e) => {
            selectedRank = e.target.value;
            renderDashboard();
        });

        courseFilterSelect.addEventListener('change', (e) => {
            selectedCourse = e.target.value;
            renderDashboard();
        });

        studentSelect.addEventListener('change', (e) => {
            selectedStudent = e.target.value;
            renderDashboard();
        });

        showOverallBtn.addEventListener('click', () => {
            isOverallView = true;
            renderDashboard();
        });

        showPersonalBtn.addEventListener('click', () => {
            isOverallView = false;
            renderDashboard();
        });

        getAiSuggestionBtn.addEventListener('click', getAISuggestion);


        // Initial render when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // No student selected initially, as we are on the login page
            selectedStudent = '';
            renderDashboard(); // Initial render to show login page
        });
    </script>
</body>
</html>
